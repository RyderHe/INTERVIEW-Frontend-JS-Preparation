# 7.3 async/await

ğŸ”· å¼‚æ­¥å›è°ƒ æœ‰ callback hellçš„é—®é¢˜

ğŸ”· è§£å†³æ–¹æ³•æœ‰ Promise \(then catch é“¾å¼è°ƒç”¨\)ï¼Œ ä½†æ˜¯ä¹ŸåŸºäºå›è°ƒå‡½æ•°

ğŸ”¶ aynsc/awaitæ˜¯åŒæ­¥è¯­æ³•æ¥ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œ çœ‹ä¼¼æ¶ˆç­äº†å›è°ƒå‡½æ•°

æ¼”ç¤º:

ç”¨loadImgè¿™ä¸ªä¾‹å­ï¼Œ [å¯¹æ¯”Promiseå†™æ³• ğŸ¦](../6.-yi-bu-3/) 

```javascript
function loadImg(src) {
  const p = new Promise((resolve, reject) ={
      const img = document.createElement("img");
      img.onLoad = () ={
          resolve(img);
      }
      img.onerror = () ={
          const err = new Error("å›¾ç‰‡åŠ è½½å¤±è´¥");
          reject(err);
      }
      img.src = src;
  });
  return p;
}

const url1 = "https://avatars.githubusercontent.com/RyderHe";
const url2 = "https://avatars.githubusercontent.com/kimberly332";

(aynsc function () {
    const img1 = await loadImg(url1);
    console.log(img1.height, img1.width);

    const img2 = await loadImg(url2);
    console.log(img2.height, img2.width);
})()
```

æˆ–è€… æ¢ç§å†™æ³• \(æœ‰ç‚¹å¤šæ­¤ä¸€ä¸¾ æ¼”ç¤ºç”¨\)

```javascript
async function loadImg1() {
    const img1 = await loadImg(url1);
    console.log(img1.height, img1.width);
}

async function loadImg2() {
    const img2 = await loadImg(url2);
    console.log(img2.height, img2.width);
}

async function() {
    const img1 = await loadImg1()
    const img2 = await loadImg2()
}
```

## aysync/await å’Œ promise çš„å…³ç³» â— 

é‡è¦ï¼ï¼

ğŸ”¶ async/await æ˜¯æ¶ˆç­å¼‚æ­¥å›è°ƒçš„ç»ˆææ­¦å™¨

ğŸ”¶ ä½†æ˜¯å’Œ Promise å¹¶ä¸äº’æ–¥

ğŸ”¶ ä¸¤è€…æ˜¯ ç›¸è¾…ç›¸æˆçš„

{% hint style="info" %}
1. æ‰§è¡Œ **async** å‡½æ•°ï¼Œè¿”å›çš„æ˜¯Promiseå¯¹è±¡
2. **await** ç›¸å½“äº Promise çš„ then
3. **try...catch** å¯æ•è·å¼‚å¸¸ï¼Œä»£æ›¿äº† Promise çš„ catch
4. awaitçš„åé¢ï¼Œ éƒ½å¯ä»¥çœ‹åšcallbackçš„å†…å®¹ï¼Œ å³å¼‚æ­¥
{% endhint %}

1. æ‰§è¡Œ **async** å‡½æ•°ï¼Œè¿”å›çš„æ˜¯Promiseå¯¹è±¡

```javascript
async function fn1() {
    return Promise.resolve(200);
}

const res1 = fn1();
console.log(res1); // æ‰“å°Promiseå¯¹è±¡ <- Promise resolved 200

res1.then(data => {
    console.log("data", data); // æ‰“å°200
})
```

å¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªå€¼çš„è¯ï¼Œä¼šåˆ†è£…æˆPromiseå¯¹è±¡

```javascript
async function fn1() {
    return 100; // ç›´æ¥è¿”å›ä¸€ä¸ªå€¼ -> ç›¸å½“äº return Promise.resolve(100)
}

const res1 = fn1();
console.log(res1); // æ‰“å°Promiseå¯¹è±¡ <- Promise resolved 100

res1.then(data => {
    console.log("data", data); // æ‰“å°100
})
```

   2. **await** ç›¸å½“äº Promise çš„ then

```javascript
(async function() {
    const p1 = Promise.resolve(300);
    const data = await p1; // ç›¸å½“äº Promise.resolve(300).then
    console.log(data); // æ‰“å°300
})()
```

å¦‚æœ awaitåé¢è·Ÿçš„æ˜¯ä¸€ä¸ªéPromiseçš„å€¼, ä¼šåˆ†è£…æˆPromise

```javascript
(async function() {
    const data = await 400; // await Promise.resolve(400) 
                            // <=> Promise.resolve(400).then
    console.log(data); // æ‰“å°400
})()
```

æ³¨æ„: å½“promiseçš„çŠ¶æ€æ˜¯rejectedï¼Œéœ€è¦promiseçš„catchï¼›await æ— æ³•å¤„ç† \(await ç›¸å½“äº Promise çš„ then\)ï¼Œ æ‰€ä»¥éœ€è¦ try...catch block

```javascript
(async function() {
    const p = Promise.reject("error"); // rejected çŠ¶æ€
    const res = await p; // await ç›¸å½“äº then
                         // rejectedçŠ¶æ€ä¸ä¼šèµ°then
                         // æŠ¥é”™
    console.log(res);
})()
```

è¿æ¥1å’Œ2ï¼š

```javascript
async function fn1() {
    return Promise.resolve(200);
}

(async function() {
    const data = await fn1(); // fn1 return Promise
                              // ç›¸å½“äº await Promise.resolve(200)
                              // ç›¸å½“äº Promise.resolve(200).then
                              
    console.log(data); // æ‰“å°200
})()
```

   3. try...catch å¯æ•è·å¼‚å¸¸ï¼Œä»£æ›¿äº† Promise çš„ catch

```javascript
(async function() {
    const p = Promise.reject("error"); // rejected çŠ¶æ€
    try {
        const res = await p; // Promise.then()
        console.log(res);
    } catch (ex) {
        console.error(ex); // æ‰“å° error
    }
})()
```

## å¼‚æ­¥çš„æœ¬è´¨

ğŸ”¶ async/await æ˜¯æ¶ˆç­å¼‚æ­¥å›è°ƒçš„ç»ˆææ­¦å™¨

ğŸ”¶ JSè¿˜æ˜¯å•çº¿ç¨‹ï¼Œè¿˜å¾—æ˜¯æœ‰å¼‚æ­¥ï¼Œè¿˜æ˜¯è¦åŸºäºevent loop

ğŸ”¶ async/awaitåªæ˜¯è¯­æ³•ç³–ï¼Œä¾ç„¶éœ€è¦ç¬¦åˆå¼‚æ­¥çš„è§„åˆ™

```javascript
async function async1() {
    console.log("async1 start"); // 2
    await async2(); // undefined

    // æ³¨æ„: awaitçš„åé¢ï¼Œ éƒ½å¯ä»¥çœ‹åšcallbackçš„å†…å®¹ï¼Œ å³å¼‚æ­¥
    //   ç±»ä¼¼ï¼Œ event loopï¼ŒsetTimeout
    //   setTimeout(funciton() {console.log("async1 end"); })
    //   Promise.resolve().then(() => {console.log("async1 end"); })
    //   å…·ä½“è¯·çœ‹ å¾®ä»»åŠ¡/å®ä»»åŠ¡
    console.log("async1 end"); // 5
}

async function async2() {
    console.log("async2"); // 3
}

console.log("script start"); // 1
async1();
console.log("script end"); // 4
// åŒæ­¥ä»£ç å·²ç»æ‰§è¡Œå®Œï¼Œç°åœ¨event loopå¼€ä½¿å·¥ä½œ
```

```javascript
async function async1() {
    console.log("async1 start"); // 2
    await async2(); 

    // ä¸‹é¢ä¸‰è¡Œéƒ½æ˜¯ å¼‚æ­¥å›è°ƒ callback çš„å†…å®¹ 
    console.log("async1 end"); // 5
    await async3(); 
        // ä¸‹é¢ä¸€è¡Œåˆæ˜¯å¼‚æ­¥å›è°ƒ callbackçš„å†…å®¹
        console.log("async1 end 2");  // 7
}

async function async2() {
    console.log("async2"); // 3
}

async function async3(){
    console.log("async3"); // 6
}
console.log("script start");  // 1
async1();
console.log("script end"); // 4
// åŒæ­¥ä»£ç æ‰§è¡Œå®Œ eventloopå¼€å§‹å·¥ä½œ
```

