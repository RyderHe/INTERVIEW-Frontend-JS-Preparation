---
description: Macro Task & Micro Task
---

# 7.5 å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

```javascript
console.log(100); 

// å®ä»»åŠ¡
setTimeout(() => {
    console.log(200); // å¼‚æ­¥å›è°ƒ
});

// å¾®ä»»åŠ¡
Promise.resolve().then(() => { // Promise.then ä¹Ÿæ˜¯å¼‚æ­¥å›è°ƒ
    console.log(300); 
});

console.log(400);

// 100 400 | 300 200 
//            ?   ?
```

300 åå‡ºåœºï¼Œ å´æ¯”200 å…ˆæ‰“å°ï¼Œ ä¸ºä»€ä¹ˆï¼Ÿ

## å®ä»»åŠ¡ vs å¾®ä»»åŠ¡

{% hint style="info" %}
* å®ä»»åŠ¡: setTimeout, setInterval, Ajax, DOMäº‹ä»¶
* å¾®ä»»åŠ¡: Promise, async/await
{% endhint %}

â— **å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœºæ¯”å®ä»»åŠ¡æ—©**

â— åŒºåˆ« \(ä¸ºä»€ä¹ˆ å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœºæ¯”å®ä»»åŠ¡æ—©\)

* å®ä»»åŠ¡: DOM æ¸²æŸ“**å**è§¦å‘ï¼Œå¦‚ setTimeout
* å¾®ä»»åŠ¡: DOM æ¸²æŸ“**å‰**è§¦å‘ï¼Œå¦‚ Promise

ğŸ”· JS æ‰§è¡Œçš„æ—¶å€™ï¼Œå¾—ç•™ä¸€äº›æ—¶æœºç»™ **DOM æ¸²æŸ“**

```javascript
// DOMæ¸²æŸ“ çš„ å†…å®¹
const $p1 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p2 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p3 = $("<p>ä¸€æ®µæ–‡å­—</p>");

$("#container").append($p1).append($p2).append($p3);

console.log("length", $("#container").children().length); // 3

// å¾®ä»»åŠ¡: DOMæ¸²æŸ“å‰è§¦å‘
Promise.resolve().then(() => {
    console.log("length1",
        $("#container").children().length
    ); // 3
    alert("promise then"); // æ­¤æ—¶ DOM æ¸²æŸ“äº†å—ï¼ŸNO
})

// å®ä»»åŠ¡: DOMæ¸²æŸ“åè§¦å‘
setTimeout(() => {
    console.log("length2",
        $("#container").children().length
    ); // 3
    alert("setTimeout"); // æ­¤æ—¶ DOM æ¸²æŸ“äº†å—ï¼ŸYES
})
```

## event loop å’Œ DOM æ¸²æŸ“

ğŸ”· JS æ˜¯å•çº¿ç¨‹çš„ï¼Œè€Œä¸”å’Œ DOM æ¸²æŸ“ å…±ç”¨ä¸€ä¸ªçº¿ç¨‹

ğŸ”· JS æ‰§è¡Œçš„æ—¶å€™ï¼Œå¾—ç•™ä¸€äº›æ—¶æœºç»™ DOM æ¸²æŸ“

```javascript
const $p1 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p2 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p3 = $("<p>ä¸€æ®µæ–‡å­—</p>");

$("#container").append($p1).append($p2).append($p3);

console.log("length", $("#container").children().length); // 3
```

ä½•æ—¶æ‰§è¡ŒDOM æ¸²æŸ“ï¼Ÿ[å›é¡¾ event loop è¿‡ç¨‹ ğŸ¦ ](7.1-event-loop.md#event-loop-guo-cheng)

* æ¯æ¬¡ call stack æ¸…ç©º \(å³æ¯æ¬¡è½®è¯¢ç»“æŸ\)ï¼Œ å³åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå†æ£€æŸ¥æ˜¯å¦æœ‰å¾®ä»»åŠ¡
* å¦‚æœæœ‰å¾®ä»»åŠ¡ï¼Œæ‰§è¡Œ
* æ‰§è¡Œå®Œå¾®ä»»åŠ¡ï¼Œ æ˜¯DOMé‡æ–°æ¸²æŸ“çš„æœºä¼šã€‚ DOMç»“æ„å¦‚æœ‰æ”¹å˜åˆ™é‡æ–°æ¸²æŸ“
* ç„¶åå†å»è§¦å‘ä¸‹ä¸€æ¬¡ event loop \(å®ä»»åŠ¡\)

 å¯¹äº å®ä»»åŠ¡ï¼š

![eventloop dom&#x6E32;&#x67D3; - &#x5B8F;&#x4EFB;&#x52A1;](../../.gitbook/assets/eventloop-dom.png)

 å¯¹äº å¾®ä»»åŠ¡ï¼š

![eventloop dom&#x6E32;&#x67D3; - &#x5FAE;&#x4EFB;&#x52A1;](../../.gitbook/assets/eventloop-dom2.png)

æ€»ç»“ï¼š

![eventloop dom&#x6E32;&#x67D3; - &#x603B;&#x7ED3;](../../.gitbook/assets/eventloop-dom3.png)

ä¸ºä»€ä¹ˆ?

* å®ä»»åŠ¡: DOM æ¸²æŸ“åè§¦å‘ï¼Œå¦‚ setTimeout
* å¾®ä»»åŠ¡: DOM æ¸²æŸ“å‰è§¦å‘ï¼Œå¦‚ Promise

å› ä¸º

* å®ä»»åŠ¡æ˜¯ç”±æµè§ˆå™¨è§„å®šçš„
* å¾®ä»»åŠ¡æ˜¯ES6è¯­æ³•å’Œè§„å®šçš„

```javascript
const $p1 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p2 = $("<p>ä¸€æ®µæ–‡å­—</p>");
const $p3 = $("<p>ä¸€æ®µæ–‡å­—</p>");

$("#container").append($p1).append($p2).append($p3);

console.log("length", $("#container").children().length); //3
alert("æœ¬æ¬¡ call stack ç»“æŸï¼Œ DOM ç»“æ„å·²æ›´æ–°ï¼Œ ä½†å°šæœªè§¦å‘DOMæ¸²æŸ“");
// alert ä¼šé˜»æ–­JSæ‰§è¡Œï¼Œä¹Ÿä¼šé˜»æ–­DOMæ¸²æŸ“
// åªæœ‰å½“æ‰‹åŠ¨ç¡®è®¤å»ç»“æŸalertï¼Œçœ¼ç›æ‰èƒ½çœ‹åˆ°DOMæ¸²æŸ“
```

